# @configure_input@

# Package-specific substitution variables
package 	= @PACKAGE_NAME@
version 	= @PACKAGE_VERSION@
tarname 	= @PACKAGE_TARNAME@
distdir 	= $(tarname)-$(version)

# VPATH-specific substitution variables
srcdir          = @srcdir@
VPATH           = @srcdir@

# Compiler variable,ie: ifort, mpif90, nagfor, etc..
FC 			= gfortran
FCFLAGS 	?= -fbacktrace -Ofast
FCDEBUG 	?= -fbacktrace -Wall -Wextra -fbounds-check -fasynchronous-unwind-tables -g
export FC FCFLAGS FCDEBUG

prefix		= @prefix@
exec_prefix = @exec_prefix@
bindir		= @bindir@

.PHONY: all check clean install installcheck dist FORCE distcheck uninstall

#$(MAKE) -C src $@
all install uninstall:
	cd src/ && $(MAKE) $@

check: all
	$(MAKE) -C test check

clean:
	$(MAKE) -C src clean
	$(MAKE) -C test clean

dist: $(distdir).tar.gz

$(distdir).tar.gz: $(distdir)
	tar chof - $(distdir) | gzip -9 -c > $@
	rm -rf $(distdir)

$(distdir): FORCE
	mkdir -p $(distdir)/src
	mkdir -p $(distdir)/test
	mkdir -p $(distdir)/doc
	cp $(srcdir)/configure.ac $(distdir)
	cp $(srcdir)/configure $(distdir)
	cp $(srcdir)/Makefile.in $(distdir)
	cp $(srcdir)/test/Makefile.in $(distdir)/test
	cp $(srcdir)/test/*.f90 $(distdir)/test
	cp $(srcdir)/src/Makefile.in $(distdir)/src
	cp $(srcdir)/src/*.f90 $(distdir)/src
	cp $(srcdir)/README.md $(distdir)
	cp $(srcdir)/taskrev-ford.md.in $(distdir)
	cp $(srcdir)/doc/Makefile.am $(distdir)/doc
	cp $(srcdir)/doc/Makefile.in $(distdir)/doc

distcheck: $(distdir).tar.gz
	gzip -cd $(distdir).tar.gz | tar xvf -
	cd $(distdir) && ./configure --with-ford=`which ford`
	cd $(distdir) && $(MAKE) all
	cd $(distdir) && $(MAKE) check
	cd $(distdir) && $(MAKE) DESTDIR=$${PWD}/inst install
	cd $(distdir) && $(MAKE) DESTDIR=$${PWD}/inst uninstall
	@remaining="`find $${PWD}/$(distdir)/_inst -type f | wc -l`"; \
	if test "$${remaining}" -ne 0; then \
	echo "*** $${remaining} file(s) remaining in stage directory!"; \
	exit 1; \
	fi
	cd $(distdir) && $(MAKE) clean
	rm -rf $(distdir)
	@echo "*** Package $(distdir).tar.gz is ready for distribution."

installcheck:
	which RomanNum
	@echo '=$(bindir)/RomanNum'

FORCE:
	-rm $(distdir).tar.gz >/dev/null 2>&1
	-rm -rf $(distdir) >/dev/null 2>&1

Makefile: Makefile.in config.status
	./config.status $@

config.status: configure
	./config.status --recheck

# End of the makefile
